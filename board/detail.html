<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CoreON - 게시글 상세</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;margin:0;background:#f5f7fb;color:#1f2937;}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px;}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(17,24,39,.06);padding:18px;}
    .top{display:flex;gap:12px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;}
    h1{font-size:22px;margin:0 0 6px;}
    .meta{color:#6b7280;font-size:13px;display:flex;gap:10px;flex-wrap:wrap;}
    .content{margin-top:16px;line-height:1.75;white-space:pre-wrap;}
    .btns{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    button,.btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:600;}
    button.primary{background:#1f4bd8;border-color:#1f4bd8;color:#fff;}
    button.danger{background:#fff;border-color:#ef4444;color:#ef4444;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    a.btn{display:inline-block;text-decoration:none;}
    .hr{height:1px;background:#e5e7eb;margin:16px 0;}
    .attachments a{display:block;padding:8px 0;color:#1f4bd8;text-decoration:none;}
    .attachments a:hover{text-decoration:underline;}
    .toast{margin-top:12px;color:#b45309;font-size:13px;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div>
        <h1 id="title">로딩 중...</h1>
        <div class="meta">
          <span id="category"></span>
          <span id="dept"></span>
          <span id="author"></span>
          <span id="createdAt"></span>
          <span id="viewCount"></span>
        </div>
      </div>

      <div class="btns">
        <a class="btn" href="/board/list.html">목록</a>
        <button id="editBtn" class="primary">수정</button>
        <button id="deleteBtn" class="danger">삭제</button>
      </div>
    </div>

    <div class="hr"></div>

    <div id="content" class="content"></div>

    <div class="hr"></div>

    <div class="attachments">
      <strong>첨부파일</strong>
      <div id="attachList" style="margin-top:8px;color:#6b7280;font-size:13px;">없음</div>
    </div>

    <div id="toast" class="toast"></div>
  </div>
</div>

<script src="/assets/api-config.js"></script>
<script>
  const $ = (id) => document.getElementById(id);
 

  function qs(name){
    return new URLSearchParams(location.search).get(name);
  }

  function fmtDate(v){
    if(!v) return "";
    const d = new Date(v);
    if (isNaN(d.getTime())) return String(v);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  async function fetchText(url, options={}){
    const res = await fetch(url, { credentials: "include", ...options });
    const text = await res.text().catch(()=> "");
    return { res, text };
  }

  async function fetchJson(url, options={}){
    const { res, text } = await fetchText(url, options);
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch(e) {}
    return { res, data, text };
  }

  const boardId = qs("boardId");
  if(!boardId){
    alert("boardId가 없습니다. 목록으로 이동합니다.");
    location.href = "/board/list.html";
  }

  let post = null;
  let attachments = [];

  async function loadDetail(){
    $("toast").textContent = "";

    // 1) 게시글 상세
    const {res, data, text} = await fetchJson(`${API_HOST.BOARD}/api/board/posts/${boardId}`);
    if(res.status === 401){
      const next = encodeURIComponent(location.pathname + location.search);
      location.href = `/auth/login.html?next=${next}`;
      return;
    }
    if(!res.ok){
      alert(text || "상세 조회 실패");
      location.href = "/board/list.html";
      return;
    }

    post = data && data.post ? data.post : data;

    $("title").textContent = post.title || "";
    $("category").textContent = post.category ? `분류: ${post.category}` : "";
    $("dept").textContent = post.dept ? `부서: ${post.dept}` : "";
    $("author").textContent = post.authorName ? `작성자: ${post.authorName} (${post.authorId ?? "-"})` : "";
    $("createdAt").textContent = post.createdAt ? `작성일: ${fmtDate(post.createdAt)}` : "";
    $("viewCount").textContent = (post.viewCount !== undefined && post.viewCount !== null) ? `조회수: ${post.viewCount}` : "";
    $("content").textContent = post.content || "";

    // 2) 첨부 목록 별도 조회
    await loadAttachments(boardId);
  }

  async function loadAttachments(boardId){
    const box = $("attachList");
    box.textContent = "불러오는 중...";

    const {res, data, text} = await fetchJson(`${API_HOST.BOARD}/api/board/posts/${boardId}/attachments`);
    if(res.status === 401){
      const next = encodeURIComponent(location.pathname + location.search);
      location.href = `/auth/login.html?next=${next}`;
      return;
    }
    if(!res.ok){
      console.error("attachments load fail:", res.status, text);
      box.textContent = "첨부 로딩 실패";
      return;
    }

    attachments = Array.isArray(data) ? data : [];
    renderAttachments(attachments);
  }

  function renderAttachments(list){
    const box = $("attachList");
    if(!list || list.length === 0){
      box.textContent = "없음";
      return;
    }

    box.innerHTML = "";
    list.forEach(att => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.gap = "10px";
      row.style.padding = "8px 0";
      row.style.borderTop = "1px solid #e5e7eb";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const name = document.createElement("div");
      name.style.fontWeight = "700";
      name.style.color = "#1f4bd8";
      name.style.cursor = "pointer";
      name.style.overflow = "hidden";
      name.style.textOverflow = "ellipsis";
      name.style.whiteSpace = "nowrap";
      name.textContent = att.originalName || att.storedUrl || "file";
      name.addEventListener("click", () => downloadAttachment(att.attachmentId));

      const meta = document.createElement("div");
      meta.style.color = "#6b7280";
      meta.style.fontSize = "12px";
      meta.style.marginTop = "3px";
      meta.textContent = att.contentType ? `${att.contentType}` : "";

      left.appendChild(name);
      left.appendChild(meta);

      const btn = document.createElement("button");
      btn.textContent = "다운로드";
      btn.className = "btn";
      btn.addEventListener("click", () => downloadAttachment(att.attachmentId));

      row.appendChild(left);
      row.appendChild(btn);

      box.appendChild(row);
    });

    // 첫 줄 border-top 제거
    if (box.firstElementChild) box.firstElementChild.style.borderTop = "none";
  }

  async function downloadAttachment(attachmentId){
    if(!attachmentId){
      alert("첨부 ID가 없습니다.");
      return;
    }

    const {res, data, text} = await fetchJson(
      `${API_HOST.BOARD}/api/board/attachments/${attachmentId}/download-url?expiresSeconds=300`
    );

    if(res.status === 401){
      const next = encodeURIComponent(location.pathname + location.search);
      location.href = `/auth/login.html?next=${next}`;
      return;
    }
    if(!res.ok){
      alert(text || `다운로드 URL 발급 실패: ${res.status}`);
      return;
    }

    const url = data?.url;
    if(!url){
      alert("다운로드 URL이 비어있습니다.");
      return;
    }

    // ✅ presigned URL로 이동 -> Content-Disposition에 따라 다운로드됨
    window.location.href = url;
  }

  $("editBtn").addEventListener("click", ()=>{
    location.href = `/board/edit.html?boardId=${boardId}`;
  });

  $("deleteBtn").addEventListener("click", async ()=>{
    if(!confirm("정말 삭제하시겠습니까?")) return;

    const {res, text} = await fetchText(`${API_HOST.BOARD}/api/board/posts/${boardId}`, { method: "DELETE" });

    if(res.status === 204){
      alert("삭제되었습니다.");
      location.href = "/board/list.html";
      return;
    }
    if(res.status === 401){
      alert("로그인이 필요합니다.");
      return;
    }
    if(res.status === 403){
      alert("삭제 권한이 없습니다.");
      return;
    }
    alert(text || `삭제 실패: ${res.status}`);
  });

  loadDetail();
</script>

</body>
</html>
